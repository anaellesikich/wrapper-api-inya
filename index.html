<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Inya — Inclusive Language Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0c0f; --panel: #151821; --panel-2: #1b1f2b; --text: #e7eaf3; --muted: #9aa3b2;
      --accent: #7c9cff; --accent-2: #88f; --user: #2b2f3a; --assistant: #1a1f2e; --border: #252a38;
      --success: #39d98a; --warn: #ffd166; --danger: #ff6b6b;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f7f8fb; --panel: #ffffff; --panel-2: #f2f4f8; --text: #0e1320; --muted: #4b5565;
        --accent: #3b82f6; --accent-2: #2751d5; --user: #e8ecf7; --assistant: #eef2ff; --border: #e5e7eb;
      }
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); color: var(--text);
      font: 15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .app { display: grid; grid-template-rows: auto 1fr auto; height: 100%; max-width: 980px; margin: 0 auto; }
    header { padding: 18px 16px; border-bottom: 1px solid var(--border); background: var(--panel); position: sticky; top: 0; z-index: 5; }
    header h1 { margin: 0; font-size: 20px; font-weight: 700; letter-spacing: .2px; }
    header .sub { color: var(--muted); font-size: 14px; margin-top: 6px; line-height: 1.4; }
    .chat { padding: 16px; overflow: auto; background: radial-gradient(1200px 500px at 50% -200px, var(--panel-2), transparent); }
    .bubble { display: grid; grid-template-columns: 40px 1fr; gap: 12px; margin: 10px 0; align-items: start; }
    .avatar { width: 36px; height: 36px; border-radius: 50%; display: grid; place-items: center; font-weight:700; font-size:12px; background: var(--accent); color:#fff; }
    .avatar.user { background: var(--muted); }
    .msg { border: 1px solid var(--border); background: var(--assistant); border-radius: 16px; padding: 12px 14px; overflow-wrap: anywhere; box-shadow: 0 1px 8px rgba(0,0,0,.05); }
    .user .msg { background: var(--user); }
    .tools { display:flex; gap:8px; margin-top:6px; color:var(--muted); font-size:12px; }
    .tools button { background:transparent; border:1px solid var(--border); color:var(--muted); padding:4px 8px; border-radius:8px; cursor:pointer; }
    .tools button:hover { border-color: var(--accent); color: var(--accent); }
    .composer { background: var(--panel); border-top: 1px solid var(--border); padding: 12px; position: sticky; bottom: 0; z-index: 5; }
    .row { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:end; max-width:980px; margin:0 auto; }
    textarea { width:100%; min-height:44px; max-height:160px; resize:none; border:1px solid var(--border); border-radius:12px; padding:10px 12px; background:var(--panel-2); color:var(--text); outline:none; }
    textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 18%, transparent); }
    .send { height:44px; padding:0 16px; border-radius:12px; border:none; background:var(--accent); color:#fff; font-weight:600; cursor:pointer; }
    .send:disabled { opacity:.6; cursor:not-allowed; }
    .top-actions { display:flex; gap:8px; margin-top:8px; }
    .chip { border:1px solid var(--border); color:var(--muted); padding:4px 8px; border-radius:999px; font-size:12px; background:transparent; cursor:pointer; }
    .chip:hover { border-color: var(--accent); color: var(--accent); }
    .system-bar { display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:8px; }
    .system-bar .status { color:var(--muted); font-size:12px; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>INYA — Inclusive Language Consultant and Educator</h1>
      <p class="sub">
        Inya helps you make your writing more inclusive, clear, and respectful.
        You can paste text for review or ask questions about inclusive language
        guided by Microsoft and King’s internal guidelines.
      </p>
      <div class="system-bar">
        <div class="top-actions">
          <input type="file" id="fileInput" style="display:none" />
          <button class="chip" id="uploadBtn">Upload file</button>
          <button class="chip" id="clearBtn">Clear</button>
          <button class="chip" id="copyBtn">Copy chat</button>
        </div>
      </div>
    </header>

    <main class="chat" id="chat"></main>

    <footer class="composer">
      <div class="row">
        <textarea id="input" placeholder="Type your message… (Shift+Enter for a new line)"></textarea>
        <button class="send" id="sendBtn">Send</button>
      </div>
    </footer>
  </div>

  <!-- Optional: markdown renderer -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Your main script -->
  <script>
    // === CONFIG ===
    const API_URL   = "http://localhost:8080/v1/generate";
    const API_KEY   = "dev-secret-key";   // must match API_KEYS in your .env
    const UPLOAD_URL = "http://localhost:8080/v1/docs/upload";

    // === STATE ===
    const chatEl    = document.getElementById("chat");
    const inputEl   = document.getElementById("input");
    const sendBtn   = document.getElementById("sendBtn");
    const uploadBtn = document.getElementById("uploadBtn");
    const fileInput = document.getElementById("fileInput");
    const clearBtn  = document.getElementById("clearBtn");
    const copyBtn   = document.getElementById("copyBtn");
    const history   = [];

    // Helpers
    function toHTML(md) {
      try {
        if (window.marked && typeof marked.parse === "function") {
          return marked.parse(md);
        }
      } catch {}
      // fallback
      return (md || "").replace(/[<>&'"]/g, s => ({'<':'&lt;','>':'&gt;','&':'&amp;',"'":'&#39;','"':'&quot;'}[s]));
    }

    function bubble(role, text) {
      const wrap = document.createElement("div");
      wrap.className = `bubble ${role}`;
      wrap.innerHTML = `
        <div class="avatar ${role}">${role === "user" ? "U" : "I"}</div>
        <div class="msg">${toHTML(text)}</div>`;
      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;
      return wrap;
    }

    async function send() {
      const text = inputEl.value.trim();
      if (!text) return;

      bubble("user", text);
      history.push({ role: "user", content: text });
      inputEl.value = "";

      const thinking = bubble("assistant", "…");
      const msg = thinking.querySelector(".msg");

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-API-Key": API_KEY
          },
          body: JSON.stringify({
            messages: history,
            temperature: 0.6,
            max_tokens: 600,
            stream: false
          })
        });

        const data = await res.json();
        const reply = data.content || "No response.";
        msg.innerHTML = toHTML(reply);
        history.push({ role: "assistant", content: reply });
      } catch (err) {
        msg.textContent = "Error: " + err.message;
      }
    }

    // Upload logic
    uploadBtn?.addEventListener("click", () => fileInput.click());

    fileInput?.addEventListener("change", async () => {
      if (!fileInput.files.length) return;
      const f = fileInput.files[0];

      const uploading = bubble("assistant", `Uploading **${f.name}** …`);
      const msgBox = uploading.querySelector(".msg");

      try {
        const form = new FormData();
        form.append("file", f);

        const res = await fetch(UPLOAD_URL, {
          method: "POST",
          headers: { "X-API-Key": API_KEY },
          body: form
        });

        if (!res.ok) {
          msgBox.textContent = `Upload failed: ${res.status}`;
          return;
        }
        const j = await res.json();
        msgBox.textContent = `Uploaded ${j.filename || f.name}. Inya can now review it.`;
      } catch (e) {
        msgBox.textContent = `Network error: ${e.message}`;
      } finally {
        fileInput.value = "";
      }
    });

    // Controls & input UX
    sendBtn.addEventListener("click", send);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    clearBtn.addEventListener("click", () => {
      chatEl.innerHTML = "";
      history.length = 0;
    });

    copyBtn.addEventListener("click", async () => {
      const text = Array.from(chatEl.querySelectorAll(".bubble"))
        .map(b => `${b.classList.contains("user") ? "user" : "assistant"}: ${b.querySelector(".msg")?.innerText || ""}`)
        .join("\n");
      try {
        await navigator.clipboard.writeText(text);
        copyBtn.textContent = "Copied!";
        setTimeout(() => (copyBtn.textContent = "Copy chat"), 1200);
      } catch {}
    });
  </script>
</body>
</html>
